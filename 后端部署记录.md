系统信息：
(base) ellisfrancis@Elliss-MacBook-Pro CargoPPT % ssh -i ~/.ssh/cargoppt/cargoppt_server.pem root@8.215.32.251 -p 22
The authenticity of host '8.215.32.251 (8.215.32.251)' can't be established.
ED25519 key fingerprint is SHA256:/aHC7saMzfkoNsywYzflDfgqy4MJcSc614qFgqCiNZ4.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '8.215.32.251' (ED25519) to the list of known hosts.
Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 5.4.0-208-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro
New release '22.04.5 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


Welcome to Alibaba Cloud Elastic Compute Service !

Last login: Mon Apr 28 18:41:22 2025 from 116.228.114.190

首先，设置密钥文件权限（在您的本地电脑上执行）：
# 移动密钥到安全的位置
mkdir -p ~/.ssh/cargoppt
cp 密钥.pem ~/.ssh/cargoppt/cargoppt_server.pem

# 设置正确的权限（这一步很重要，否则 SSH 会拒绝使用该密钥）
chmod 600 ~/.ssh/cargoppt/cargoppt_server.pem

设置权限：
# 设置 .ssh 目录的权限
chmod 700 ~/.ssh
chmod 700 ~/.ssh/cargoppt

# 设置密钥文件的权限
chmod 600 ~/.ssh/cargoppt/cargoppt_server.pem

验证文件：
# 检查文件是否存在
ls -la ~/.ssh/cargoppt/cargoppt_server.pem

# ssh登录服务器
ssh -i ~/.ssh/cargoppt/cargoppt_server.pem root@8.215.32.251 -p 22


初始化设置：

1. **首先创建项目主目录**：
```bash
# 进入标准的网站目录
cd /var/www

# 创建项目主目录
sudo mkdir -p CargoTranslator
sudo chown -R root:root CargoTranslator

# 创建前后端目录
cd CargoTranslator
mkdir frontend backend logs

# 创建必要的子目录
cd backend
mkdir cache services models

# 设置目录权限
sudo chmod 755 -R /var/www/CargoTranslator
```

2. **设置项目目录结构**：
```bash
/var/www/CargoPPT/
├── frontend/          # 前端构建文件目录
├── backend/          # 后端应用目录
│   ├── cache/       # 缓存目录
│   ├── services/    # 服务模块目录
│   ├── models/      # 数据模型目录
│   └── logs/        # 日志目录
└── logs/            # 总体日志目录
```

3. **创建并配置 Python 虚拟环境**：
# 安装新版本 Python
sudo apt update
sudo apt install software-properties-common
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.9 python3.9-venv

# 重新创建虚拟环境（使用 Python 3.9）
cd /var/www/CargoTranslator/backend
deactivate  # 退出当前虚拟环境
rm -rf venv
python3.9 -m venv venv
source venv/bin/activate

# 重新安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 退出虚拟环境
deactivate


4. **设置环境配置文件**：
```bash
# 在后端目录创建环境配置文件
cd /var/www/CargoTranslator/backend
vim .env      # 环境变量配置（根据您的实际配置修改）
```

5. **设置日志目录权限**：
```bash
# 创建并设置日志目录权限
sudo mkdir -p /var/www/CargoTranslator/logs
sudo chown -R root:root /var/www/CargoTranslator/logs
sudo chmod 755 /var/www/CargoTranslator/logs
```

6. **创建系统服务配置**：
```bash
# 创建服务配置文件
sudo vim /etc/systemd/system/cargoppt.service

# 添加以下内容
[Unit]
Description=CargoTranslator Translation Service
After=network.target

[Service]
User=root
WorkingDirectory=/var/www/CargoTranslator/backend
Environment="PATH=/var/www/CargoTranslator/backend/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/var/www/CargoTranslator/backend/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000

[Install]
WantedBy=multi-user.target
```



8. **设置文件权限**：
```bash
# 设置适当的文件权限
sudo find /var/www/CargoTranslator -type d -exec chmod 755 {} \;
sudo find /var/www/CargoTranslator -type f -exec chmod 644 {} \;
sudo chmod 640 /var/www/CargoTranslator/backend/.env
```

完成这些步骤后，您的服务器就有了一个基本的项目结构。接下来我们可以：

1. 部署后端代码
2. 安装依赖
3. 配置数据库
4. 设置 Nginx

好的，我们可以直接使用 `rsync` 命令来同步本地后端代码到服务器，这样更高效且可以跳过压缩打包步骤。

1. **首先确保本地代码是最新的，并且在本地 CargoPPT 目录下**：
```bash
cd /Users/ellisfrancis/Documents/CargoPPT
```

2. **使用 rsync 直接同步代码**：
```bash
# 创建 rsync 排除文件
cat > rsync-exclude.txt << EOF
__pycache__/
*.pyc
.env
*.log
cache/
venv/
.git/
.gitignore
EOF

# 使用 rsync 同步代码到服务器
rsync -avz --exclude-from=rsync-exclude.txt \
    -e "ssh -i ~/.ssh/cargoppt/cargoppt_server.pem" \
    ./backend/ root@8.215.32.251:/var/www/CargoTranslator/backend/
```

3. **登录服务器完成部署**：
```bash
# SSH 登录到服务器
ssh -i ~/.ssh/cargoppt/cargoppt_server.pem root@8.215.32.251

# 进入项目目录
cd /var/www/CargoTranslator/backend

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt



# 确保环境变量配置正确
cat .env  # 检查并编辑环境变量

# 设置正确的文件权限
sudo chown -R root:root /var/www/CargoTranslator/backend
sudo find /var/www/CargoTranslator/backend -type d -exec chmod 755 {} \;
sudo find /var/www/CargoTranslator/backend -type f -exec chmod 644 {} \;
sudo chmod 640 /var/www/CargoTranslator/backend/.env

# 重启服务
sudo systemctl restart cargoppt

# 检查服务状态
sudo systemctl status cargoppt

# 查看日志确保没有错误
tail -f /var/www/CargoTranslator/backend/debug.log
```

4. **验证部署**：
```bash
# 测试API是否正常工作
curl http://localhost:8000/api/health
```


现在出现了两个问题：

1. **Python 版本兼容性问题**：
错误信息 `TypeError: 'type' object is not subscriptable` 表明您的代码使用了 Python 3.9+ 的类型注解语法（比如 `tuple[str, ProcessingStats]`），但服务器上的 Python 版本是 3.8.10，不支持这种语法。

2. **模块导入路径问题**：
从错误堆栈可以看到模块导入的问题：
```python
from services.term_extractor import GeminiTermExtractor
from .document_chunker import DocumentChunker
```

让我们逐步解决：

1. **首先升级 Python 版本**：
```bash
# 安装新版本 Python
sudo apt update
sudo apt install software-properties-common
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.9 python3.9-venv

# 重新创建虚拟环境（使用 Python 3.9）
cd /var/www/CargoTranslator/backend
deactivate  # 退出当前虚拟环境
rm -rf venv
python3.9 -m venv venv
source venv/bin/activate

# 重新安装依赖
pip install --upgrade pip
pip install -r requirements.txt
```


4. **重新启动服务**：
```bash
sudo systemctl restart cargoppt
sudo systemctl status cargoppt
```

看到问题了，是缺少 `tenacity` 模块。让我们在 requirements.txt 中添加这个依赖并重新安装：

1. **编辑 requirements.txt**：
```bash
# 在 requirements.txt 中添加
nano requirements.txt

# 添加以下行
tenacity==8.2.3
```

2. **重新安装依赖**：
```bash
# 确保在虚拟环境中
source venv/bin/activate

# 安装新依赖
pip install tenacity==8.2.3

# 或者重新安装所有依赖
pip install -r requirements.txt
```

3. **重启服务**：
```bash
# 重启服务
sudo systemctl restart cargoppt

# 检查状态
sudo systemctl status cargoppt
```







