好的,让我帮你规划飞书登录的实现步骤:

1. 首先在 `.env` 添加飞书相关配置:
```ini
# 添加飞书配置
FEISHU_APP_ID=cli_xxx         # 飞书应用 ID
FEISHU_APP_SECRET=xxx         # 飞书应用密钥
FEISHU_REDIRECT_URI=http://localhost:8000/api/auth/feishu/callback  # 开发环境回调地址
```

2. 创建认证相关的目录结构:
```
backend/
├── auth/
│   ├── __init__.py
│   ├── oauth.py          # OAuth2.0 认证逻辑
│   ├── models.py         # 用户模型
│   └── dependencies.py   # 认证依赖
```

3. 创建用户模型 `auth/models.py`:
```python
from sqlalchemy import Column, Integer, String, DateTime
from database import Base
from datetime import datetime

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    feishu_user_id = Column(String(255), unique=True)
    name = Column(String(255))
    email = Column(String(255))
    avatar_url = Column(String(1024))
    access_token = Column(String(255))
    refresh_token = Column(String(255))
    token_expires_at = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

4. 实现 OAuth2.0 认证逻辑 `auth/oauth.py`:
```python
from fastapi import APIRouter, HTTPException, Depends
from sqlalchemy.orm import Session
from datetime import datetime, timedelta
import httpx
from typing import Optional
import os
from database import get_db
from .models import User

router = APIRouter()

FEISHU_APP_ID = os.getenv("FEISHU_APP_ID")
FEISHU_APP_SECRET = os.getenv("FEISHU_APP_SECRET")
FEISHU_REDIRECT_URI = os.getenv("FEISHU_REDIRECT_URI")

@router.get("/api/auth/feishu/login")
async def feishu_login():
    """生成飞书授权链接"""
    auth_url = (
        "https://open.feishu.cn/open-apis/authen/v1/index"
        f"?app_id={FEISHU_APP_ID}"
        f"&redirect_uri={FEISHU_REDIRECT_URI}"
        "&state=random_state"  # 实际使用时应该生成随机state
    )
    return {"auth_url": auth_url}

@router.get("/api/auth/feishu/callback")
async def feishu_callback(
    code: str,
    state: str,
    db: Session = Depends(get_db)
):
    """处理飞书回调"""
    try:
        # 1. 获取访问令牌
        async with httpx.AsyncClient() as client:
            token_response = await client.post(
                "https://open.feishu.cn/open-apis/authen/v1/access_token",
                json={
                    "app_id": FEISHU_APP_ID,
                    "app_secret": FEISHU_APP_SECRET,
                    "grant_type": "authorization_code",
                    "code": code
                }
            )
            token_data = token_response.json()
            
            if token_response.status_code != 200:
                raise HTTPException(status_code=400, detail="Failed to get access token")
                
        # 2. 获取用户信息
        access_token = token_data["access_token"]
        async with httpx.AsyncClient() as client:
            user_response = await client.get(
                "https://open.feishu.cn/open-apis/authen/v1/user_info",
                headers={"Authorization": f"Bearer {access_token}"}
            )
            user_data = user_response.json()
            
        # 3. 创建或更新用户
        user = db.query(User).filter_by(feishu_user_id=user_data["user_id"]).first()
        if not user:
            user = User(
                feishu_user_id=user_data["user_id"],
                name=user_data["name"],
                email=user_data.get("email", ""),
                avatar_url=user_data.get("avatar_url", ""),
            )
            db.add(user)
            
        # 更新令牌信息
        user.access_token = token_data["access_token"]
        user.refresh_token = token_data["refresh_token"]
        user.token_expires_at = datetime.utcnow() + timedelta(seconds=token_data["expires_in"])
        
        db.commit()
        
        # 4. 返回登录成功信息
        return {
            "status": "success",
            "user": {
                "id": user.id,
                "name": user.name,
                "email": user.email,
                "avatar_url": user.avatar_url
            }
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

5. 在 `main.py` 中引入认证路由:
```python
from auth.oauth import router as auth_router

app = FastAPI()
# ... 其他配置 ...

# 添加认证路由
app.include_router(auth_router)
```

这是第一步的基础实现,包含了:
1. 环境配置
2. 用户模型定义
3. OAuth2.0 基本流程实现
4. 用户信息存储

后续还需要:
1. 实现令牌刷新机制
2. 添加会话管理
3. 实现权限控制
4. 添加安全措施(CSRF防护等)
5. 完善错误处理

需要我继续实现这些功能吗？


飞书返回信息
{
  "code": 0,
  "data": {
    "name": "吴川",
    "en_name": "Xavier",
    "email": "xavier@jtcargo.id",
    "enterprise_email": "xavier@jtcargo.id",
    "mobile": "+6281319039501",
    "tenant_key": "1794ea19cede5758",
    "user_id": "ID00000048",
    "open_id": "ou_8bd1a2f64507facb4b19c1ecd023c0c1",
    "union_id": "on_85f5929baa6ffdf32be605e4ff0aa285",
    "avatar_url": "https://s16-imfile-sg.feishucdn.com/..."
  },
  "msg": "success"
}